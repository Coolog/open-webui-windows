name: Build Windows Installer

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download Python Embeddable
      run: |
        # 下载 Python 3.11 嵌入式版本（不需要安装，可直接运行）
        $pythonUrl = "https://www.python.org/ftp/python/3.11.9/python-3.11.9-embed-amd64.zip"
        $pipUrl = "https://bootstrap.pypa.io/get-pip.py"
        
        Write-Host "Downloading Python 3.11 embeddable..."
        Invoke-WebRequest -Uri $pythonUrl -OutFile "python-embed.zip" -UseBasicParsing
        
        Write-Host "Extracting Python..."
        Expand-Archive -Path "python-embed.zip" -DestinationPath "python" -Force
        
        # 修改 python311._pth 以启用 pip 和 site-packages
        $pthFile = "python/python311._pth"
        $pthContent = @"
python311.zip
.
Lib/site-packages

import site
"@
        Set-Content -Path $pthFile -Value $pthContent
        
        # 创建 Lib/site-packages 目录
        New-Item -ItemType Directory -Path "python/Lib/site-packages" -Force
        
        # 下载 get-pip.py
        Write-Host "Downloading pip..."
        Invoke-WebRequest -Uri $pipUrl -OutFile "python/get-pip.py" -UseBasicParsing
        
        # 安装 pip
        Write-Host "Installing pip..."
        & "python/python.exe" "python/get-pip.py" --no-warn-script-location
        
        # 验证
        Write-Host "Python version:"
        & "python/python.exe" --version
        Write-Host "Pip version:"
        & "python/python.exe" -m pip --version
        
        # 列出文件
        Write-Host "Python directory contents:"
        Get-ChildItem -Path "python" -Name
      shell: pwsh
    
    - name: Download and Setup Inno Setup
      run: |
        $url = "https://jrsoftware.org/download.php/is.exe"
        $output = "$env:TEMP\innosetup.exe"
        Write-Host "Downloading Inno Setup..."
        Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
        
        Write-Host "Installing Inno Setup..."
        Start-Process -FilePath $output -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait
        
        $innoPath = "C:\Program Files (x86)\Inno Setup 6"
        echo "$innoPath" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
      shell: pwsh
    
    - name: Create output directory
      run: mkdir -p output
      shell: bash
    
    - name: Build Installer
      run: |
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" setup.iss
      shell: pwsh
    
    - name: List output files
      run: |
        Write-Host "=== Output directory contents ==="
        Get-ChildItem -Path output -Recurse | Format-Table Name, Length
      shell: pwsh
    
    - name: Upload Installer Artifact
      uses: actions/upload-artifact@v4
      with:
        name: OpenWebUI-Windows-Installer
        path: output/*.exe
        retention-days: 30
    
    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: output/*.exe
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
